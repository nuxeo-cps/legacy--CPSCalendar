<metal:block define-macro="event_view">
  <tal:block
    define="
      organizer event/organizer|nothing;
      title event/title;
      id event/id|nothing;
      title python:title or id;
      from_date event/from_date;
      to_date event/to_date;
      all_day event/all_day;
      location event/location;
      event_status event/event_status;
      date_fmt python:all_day and mcat('_cal_%m/%d/%Y_')
        or mcat('_cal_%m/%d/%Y at %H:%M_');
      attendees event/attendees;
      transparent event/transparent|nothing;
      transparent python:not not transparent;
      cat_infos here/calendar_categories;
      categories cat_infos/categories;
      cat_default cat_infos/default;
      cat_def_title categories/?cat_default/title;
      category event/category|nothing;
    ">
    <metal:block use-macro="here/main_widgets/macros/form">
      <metal:block fill-slot="content">
        <tal:block condition="organizer">
          <metal:block use-macro="here/main_widgets/macros/form_property">
            <metal:block fill-slot="title"
              tal:content="python:mcat('_cal_prop_organizer_')">
              Organizer
            </metal:block>
            <metal:block fill-slot="content"
              tal:content="organizer/cn|organizer/id">
              organizer
            </metal:block>
          </metal:block>
        </tal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title"
            tal:content="python:mcat('_cal_prop_summary_')">
            Summary
          </metal:block>
          <metal:block fill-slot="content"
            tal:content="title">
            title
          </metal:block>
        </metal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title"
            tal:content="python:mcat('_cal_prop_date_')">
            Date
          </metal:block>
          <metal:block fill-slot="content"
            tal:define="
              from_date_str python:from_date.strftime(date_fmt);
              to_date_str python:to_date.strftime(date_fmt);
              one_date python:from_date_str == to_date_str">
            <tal:block condition="one_date"
              tal:content="from_date_str">
            </tal:block>
            <tal:block condition="not:one_date">
              <tal:block replace="python:mcat('_cal_date_From_')">
                From
              </tal:block>
              <tal:block replace="from_date_str" />
              <br>
              <tal:block replace="python:mcat('_cal_date_To_')">
                To
              </tal:block>
              <tal:block replace="to_date_str" />
            </tal:block>
          </metal:block>
        </metal:block>
        <tal:block condition="location">
          <metal:block use-macro="here/main_widgets/macros/form_property">
            <metal:block fill-slot="title"
              tal:content="python:mcat('_cal_prop_location_')">
              Location
            </metal:block>
            <metal:block fill-slot="content"
              tal:content="location">
            </metal:block>
          </metal:block>
        </tal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title"
            tal:content="python:mcat('_cal_prop_eventstatus_')">
            Event status
          </metal:block>
          <metal:block fill-slot="content"
            tal:content="python:mcat('_cal_eventstatus_%s_' % (event_status, ))">
          </metal:block>
        </metal:block>
        <tal:block condition="attendees">
          <metal:block use-macro="here/main_widgets/macros/form_property">
            <metal:block fill-slot="title"
              tal:content="python:mcat('_cal_prop_attendees_')">
              Attendees
            </metal:block>
            <metal:block fill-slot="content">
              <ul tal:condition="attendees">
                <li tal:repeat="att attendees">
                  <strong tal:content="att/cn|att/id">attendee</strong>
                  (<tal:block replace="python:mcat('_cal_status_%s_' % (att['status'], ))">
                    Confirmed
                  </tal:block>)
                </li>
              </ul>
            </metal:block>
          </metal:block>
        </tal:block>
        <tal:block condition="category">
          <metal:block use-macro="here/main_widgets/macros/form_property">
            <metal:block fill-slot="title"
              tal:content="python:mcat('_cal_prop_category_')">
              Category
            </metal:block>
            <metal:block fill-slot="content"
              tal:define="
              cat_title categories/?category/title|cat_def_title"
              tal:content="python:mcat(cat_title)">
              Category
            </metal:block>
          </metal:block>
        </tal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title"
            tal:content="python:mcat('_cal_prop_transparent_')">
            Transparent
          </metal:block>
          <metal:block fill-slot="content"
            tal:content="python:transparent and mcat('_Yes_') or mcat('_No_')">
            Yes
          </metal:block>
        </metal:block>
      </metal:block>
    </metal:block>
  </tal:block>
</metal:block>

<metal:block define-macro="pendings_view"
  tal:define="ids here/objectIds">
  <tal:block repeat="pending pendings">
    <form action="" method="POST">
      <input type="hidden" name="event_id"
        tal:attributes="value pending/id" />
      <tal:block define="request pending/request">
        <tal:block condition="python:request == 'request'">
          <tal:block define="
            event pending/event;
            id event/id;
            in_event python:here.meta_type == 'Event';
            real_event python:(in_event and here) or (id in ids and getattr(here, id)) or nothing">
            <tal:block condition="nocall:real_event">
              <h3 tal:content="python:mcat('_cal_Event_update_')">
                Event update
              </h3>
            </tal:block>
            <tal:block condition="not:nocall:real_event">
              <h3 tal:content="python:mcat('_cal_New_event_')">
                New event
              </h3>
            </tal:block>
            <p tal:condition="event/comment|nothing">
              <strong tal:content="event/sender_cn|event_sender|nothing">
                sender
              </strong>:
              <em tal:content="event/comment">comment</em>
            </p>
            <p tal:condition="not:event/comment|nothing">
              <strong tal:content="python:mcat('_cal_Sender:')">
                Sender:
              </strong>
              <tal:block replace="event/sender_cn|event/sender|nothing">
                sender
              </tal:block>
            </p>
            <metal:block use-macro="here/calendar_macros/macros/event_view">
            </metal:block>
            <input type="submit" name="confirmPendingEvent:method"
              tal:condition="nocall:real_event"
              tal:attributes="value python:mcat('_button_validate_')" />
            <tal:block condition="not:nocall:real_event">
              <metal:block use-macro="here/main_widgets/macros/form">
                <metal:block fill-slot="content">
                  <metal:block
                    use-macro="here/main_widgets/macros/form_property">
                    <metal:block fill-slot="title"
                      tal:content="python:mcat('_prop_comment_')">
                      Comment
                    </metal:block>
                    <metal:block fill-slot="content">
                      <textarea name="comment" cols="40" rows="4"></textarea>
                    </metal:block>
                  </metal:block>
                </metal:block>
              </metal:block>
              <br />
              <select name="status"
                tal:define="
                  statuses python:['confirmed', 'tentative', 'decline', 'decline_and_delete', 'ignore'];
                  selected python:event['event_status'] == 'cancelled'
                    and 'ignore' or 'confirmed'">
                <option tal:repeat="status statuses"
                  tal:attributes="
                    value status; selected python:status == selected"
                  tal:content="python:mcat('_cal_pending_%s_' % (status, ))">
                  Confirm
                </option>
              </select>
              <input type="submit" name="calendar_confirmPendingEvent:method"
                tal:attributes="value python:mcat('_button_validate_')" />
            </tal:block>
          </tal:block>
        </tal:block>
        <tal:block condition="python:request == 'status'">
          <h3 tal:content="python:mcat('_cal_Status_update_')">
            Status update
          </h3>
          <ul>
            <li tal:repeat="attendee pending/change">
              <strong tal:content="attendee/cn|attendee/id">Attendee</strong>
              (<tal:block replace="python:mcat('_cal_status_%s_' % (attendee['status'], ))" />)
              <p tal:condition="attendee/comment|nothing">
                <strong tal:content="attendee/sender_cn|attendee/sender|nothing">
                  sender
                </strong>:
                <em tal:content="attendee/comment">comment</em>
              </p>
              <p tal:condition="not:attendee/comment|nothing">
                <strong tal:content="python:mcat('_cal_Sender:')">
                  Sender:
                </strong>
                <tal:block replace="attendee/sender_cn|attendee/sender|nothing">
                  sender
                </tal:block>
              </p>
            </li>
          </ul>
          <input type="submit" name="confirmPendingEvent:method"
            tal:attributes="value python:mcat('_button_validate_')" />
        </tal:block>
      </tal:block>
    </form>
  </tal:block>
</metal:block>

<metal:block define-macro="notifyattendees">
  <tal:block condition="python:mtool.checkPermission('Add portal content', here)">
    <tal:block define="pendings here/getPendingEvents"
      condition="pendings">
      You have pending requests for this event:
      <metal:block use-macro="here/calendar_macros/macros/pendings_view" />
    </tal:block>
    <tal:block condition="python:here.canEditThisEvent() and here.attendees and here.isdirty">
      <h3
        tal:content="python:mcat('_You have to notify other attendees of recent changes to this event_')">
        You have to notify other attendees of recent changes to this event.
      </h3>
      <form action="updateAttendeesCalendars">
        <metal:block use-macro="here/main_widgets/macros/form">
          <metal:block fill-slot="content">
            <metal:block use-macro="here/main_widgets/macros/form_property">
              <metal:block fill-slot="title"
                tal:content="python:mcat('_prop_comment_')">
                Comment
              </metal:block>
              <metal:block fill-slot="content">
                <textarea name="comment" cols="40" rows="4"></textarea>
              </metal:block>
            </metal:block>
          </metal:block>
        </metal:block>
        <input type="submit"
          tal:attributes="value python:mcat('_button_validate_')" />
      </form>
    </tal:block>
  </tal:block>
</metal:block>
