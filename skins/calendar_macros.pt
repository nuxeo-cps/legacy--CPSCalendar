<metal:block define-macro="event_view">
  <tal:block
    define="
      organizer event/organizer;
      title event/title;
      id event/id|nothing;
      title python:title or id;
      from_date event/from_date;
      to_date event/to_date;
      all_day event/all_day;
      location event/location;
      event_status event/event_status;
      date_fmt python:all_day and '%d/%m/%Y' or '%d/%m/%Y at %H:%M';
      attendees event/attendees;
    ">
    <metal:block use-macro="here/main_widgets/macros/form">
      <metal:block fill-slot="content">
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title">
            Organizer
          </metal:block>
          <metal:block fill-slot="content"
            tal:content="organizer/cn|organizer/id">
            organizer
          </metal:block>
        </metal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title">
            Summary
          </metal:block>
          <metal:block fill-slot="content"
            tal:content="title">
            title
          </metal:block>
        </metal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title">
            Date
          </metal:block>
          <metal:block fill-slot="content"
            tal:define="
              from_date_str python:from_date.strftime(date_fmt);
              to_date_str python:to_date.strftime(date_fmt);
              one_date python:from_date_str == to_date_str">
            <tal:block condition="one_date"
              tal:content="from_date_str">
            </tal:block>
            <tal:block condition="not:one_date">
              From <tal:block replace="from_date_str" />
              <br>
              To <tal:block replace="to_date_str" />
            </tal:block>
            <tal:block condition="all_day">
              <br>
              All day event
            </tal:block>
          </metal:block>
        </metal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title">
            Location
          </metal:block>
          <metal:block fill-slot="content"
            tal:content="location">
          </metal:block>
        </metal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title">
            Event status
          </metal:block>
          <metal:block fill-slot="content"
            tal:content="event_status">
          </metal:block>
        </metal:block>
        <metal:block use-macro="here/main_widgets/macros/form_property">
          <metal:block fill-slot="title">
            Attendees
          </metal:block>
          <metal:block fill-slot="content">
            <ul tal:condition="attendees">
              <li tal:repeat="att attendees">
                <strong tal:content="att/cn|att/id">attendee</strong>
                (<tal:block replace="att/status">unconfirmed</tal:block>)
              </li>
            </ul>
          </metal:block>
        </metal:block>
      </metal:block>
    </metal:block>
  </tal:block>
</metal:block>

<metal:block define-macro="pendings_view">
  <tal:block repeat="pending pendings">
    <form action="confirmPendingEvent">
      <input type="hidden" name="event_id"
        tal:attributes="value pending/id" />
      <tal:block define="request pending/request">
        <tal:block condition="python:request == 'request'">
          <h3>Update</h3>
          <tal:block define="event pending/event">
            <p tal:condition="event/comment|nothing">
              <strong tal:content="event/sender|nothing">
                sender
              </strong>:
              <em tal:content="event/comment">comment</em>
            </p>
            <p tal:condition="not:event/comment|nothing">
              <strong>Sender:</strong>
              <tal:block replace="event/sender|nothing">
                sender
              </tal:block>
            </p>
            <metal:block use-macro="here/calendar_macros/macros/event_view">
            </metal:block>
          </tal:block>
        </tal:block>
        <tal:block condition="python:request == 'status'">
          <h3>Status update</h3>
          <ul>
            <li tal:repeat="attendee pending/change">
              <strong tal:content="attendee/cn|attendee/id">Attendee</strong>
              (<tal:block replace="attendee/status" />)
              <p tal:condition="attendee/comment|nothing">
                <strong tal:content="attendee/sender|nothing">
                  sender
                </strong>:
                <em tal:content="attendee/comment">comment</em>
              </p>
              <p tal:condition="not:attendee/comment|nothing">
                <strong>Sender:</strong>
                <tal:block replace="attendee/sender|nothing">
                  sender
                </tal:block>
              </p>
            </li>
          </ul>
        </tal:block>
      </tal:block>
      <input type="submit" tal:attributes="value python:mcat('_button_validate_')" />
    </form>
  </tal:block>
</metal:block>

<metal:block define-macro="notifyattendees">
  <tal:block condition="python:mtool.checkPermission('Add portal content', here)">
    <tal:block define="pendings here/getPendingEvents"
      condition="pendings">
      You have pending requests for this event:
      <metal:block use-macro="here/calendar_macros/macros/pendings_view" />
    </tal:block>
    <tal:block condition="python:here.canEditThisEvent() and here.attendees and here.isdirty">
      <h3
        tal:content="python:mcat('_You have to notify other attendees of recent changes to this event_')">
        You have to notify other attendees of recent changes to this event.
      </h3>
      <form action="updateAttendeesCalendars">
        <metal:block use-macro="here/main_widgets/macros/form">
          <metal:block fill-slot="content">
            <metal:block use-macro="here/main_widgets/macros/form_property">
              <metal:block fill-slot="title"
                tal:content="python:mcat('_prop_comment_')">
                Comment
              </metal:block>
              <metal:block fill-slot="content">
                <textarea name="comment" cols="40" rows="4"></textarea>
              </metal:block>
            </metal:block>
          </metal:block>
        </metal:block>
        <input type="submit"
          tal:attributes="value python:mcat('_button_validate_')" />
      </form>
    </tal:block>
  </tal:block>
</metal:block>
