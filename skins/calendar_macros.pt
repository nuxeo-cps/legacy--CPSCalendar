<metal:block define-macro="event_view"
             i18n:domain="cpscalendar">
  <tal:block define="organizer event/organizer|nothing;
                     title event/title;
                     id event/id|nothing;
                     title python:title or id;
                     from_date event/from_date;
                     to_date event/to_date;
                     all_day event/all_day;
                     location event/location;
                     event_status event/event_status;
                     attendees event/attendees;
                     transparent event/transparent|nothing;
                     transparent python:not not transparent;
                     cat_infos here/calendar_categories;
                     categories cat_infos/categories;
                     cat_default cat_infos/default;
                     cat_def_title categories/?cat_default/title;
                     category event/category|nothing;">
    <metal:block use-macro="here/generic_lib/macros/form">
      <metal:block fill-slot="content">
        <tal:block condition="organizer">
          <metal:block use-macro="here/generic_lib/macros/form_property">
            <metal:block fill-slot="title"
                         i18n:translate="_cal_prop_organizer_">
              Organizer
            </metal:block>
            <metal:block fill-slot="content"
              tal:content="organizer/cn|organizer/id">
              organizer
            </metal:block>
          </metal:block>
        </tal:block>
        <metal:block use-macro="here/generic_lib/macros/form_property">
          <metal:block fill-slot="title"
                       i18n:translate="_cal_prop_summary_">
            Summary
          </metal:block>
          <metal:block fill-slot="content"
            tal:content="title">
            title
          </metal:block>
        </metal:block>
        <metal:block use-macro="here/generic_lib/macros/form_property">
          <metal:block fill-slot="title"
                       i18n:translate="_cal_prop_date_">
            Date
          </metal:block>
          <metal:block fill-slot="content"
                       tal:define="one_date python:from_date == to_date;">
            <tal:block condition="one_date"
                       tal:content="from_date_str">
            </tal:block>
            <tal:block condition="not:one_date">
              <span i18n:translate="_cal_date_From_">
                From
              </span>
              <tal:block replace="python:from_date.strftime('%m/%d/%Y ');" />
              <tal:block condition="not:all_day">
                <span i18n:translate="_cal_hour_To_" />
                <tal:block replace="python:from_date.strftime(' %H:%M');" />
              </tal:block>
              <br>
              <span i18n:translate="_cal_date_To_">
                To
              </span>
              <tal:block replace="python:to_date.strftime('%m/%d/%Y ');" />
              <tal:block condition="not:all_day">
                <span i18n:translate="_cal_hour_To_" />
                <tal:block replace="python:to_date.strftime(' %H:%M');" />
              </tal:block>
            </tal:block>
          </metal:block>
        </metal:block>
        <tal:block condition="location">
          <metal:block use-macro="here/generic_lib/macros/form_property">
            <metal:block fill-slot="title"
                         i18n:translate="_cal_prop_location_">
              Location
            </metal:block>
            <metal:block fill-slot="content"
              tal:content="location">
            </metal:block>
          </metal:block>
        </tal:block>
        <metal:block use-macro="here/generic_lib/macros/form_property">
          <metal:block fill-slot="title"
                       i18n:translate="_cal_prop_eventstatus_">
            Event status
          </metal:block>
          <metal:block fill-slot="content"
                       tal:content="python:str('_cal_eventstatus_%s_' % (event_status, ))"
                       i18n:translate="">
          </metal:block>
        </metal:block>
        <tal:block condition="attendees">
          <metal:block use-macro="here/generic_lib/macros/form_property">
            <metal:block fill-slot="title"
                         i18n:translate="_cal_prop_attendees_">
              Attendees
            </metal:block>
            <metal:block fill-slot="content">
              <ul tal:condition="attendees">
                <li tal:repeat="att attendees">
                  <strong tal:content="att/cn|att/id">attendee</strong>
                  (<tal:block content="python:str('_cal_status_%s_' % (att['status'], ))"
                              i18n:translate="">
                    Confirmed
                  </tal:block>)
                </li>
              </ul>
            </metal:block>
          </metal:block>
        </tal:block>
        <tal:block condition="category">
          <metal:block use-macro="here/generic_lib/macros/form_property">
            <metal:block fill-slot="title"
                         i18n:translate="_cal_prop_category_">
              Category
            </metal:block>
            <metal:block fill-slot="content"
                         tal:define="cat_title categories/?category/title|cat_def_title"
                         tal:content="python:str(cat_title)"
                         i18n:translate="">
              Category
            </metal:block>
          </metal:block>
        </tal:block>
        <metal:block use-macro="here/generic_lib/macros/form_property">
          <metal:block fill-slot="title"
                       i18n:translate="_cal_prop_transparent_">
            Transparent
          </metal:block>
          <metal:block fill-slot="content">
            <p tal:condition="transparent" i18n:translate="_Yes_">Yes</p>
            <p tal:condition="not:transparent" i18n:translate="_No_">No</p>
            <p>
              <small i18n:translate="_Transparent events mean that you-re not busy during this event_">
                Transparent events mean that you're not busy during this event.
              </small>
          </metal:block>
        </metal:block>
      </metal:block>
    </metal:block>
  </tal:block>
</metal:block>

<metal:block define-macro="pendings_view"
             tal:define="ids python:here.objectIds('Event')">
  <tal:block repeat="pending pendings">
    <form method="POST"
      tal:attributes="action here/absolute_url">
      <input type="hidden" name="event_id"
        tal:attributes="value pending/id" />
      <tal:block define="request pending/request">
        <tal:block condition="python:request == 'request'">
          <tal:block define="
            event pending/event;
            id event/id;
            in_event python:here.meta_type == 'Event';
            real_event python:(in_event and here) or (id in ids and getattr(here, id)) or nothing">
            <tal:block condition="nocall:real_event">
              <h3 i18n:translate="_cal_Event_update_">
                Event update
              </h3>
            </tal:block>
            <tal:block condition="not:nocall:real_event">
              <h3 i18n:translate="_cal_New_event_">
                New event
              </h3>
            </tal:block>
            <p tal:condition="event/comment|nothing">
              <strong tal:content="event/sender_cn|event_sender|nothing">
                sender
              </strong>:
              <em tal:content="event/comment">comment</em>
            </p>
            <p tal:condition="not:event/comment|nothing">
              <strong i18n:translate="_cal_Sender:">
                Sender:
              </strong>
              <tal:block replace="event/sender_cn|event/sender|nothing">
                sender
              </tal:block>
            </p>
            <metal:block use-macro="here/calendar_macros/macros/event_view">
            </metal:block>
            <input type="submit" name="confirmPendingEvent:method"
              tal:condition="nocall:real_event"
              tal:attributes="value python:str('_button_validate_')" />
            <tal:block condition="not:nocall:real_event">
              <metal:block use-macro="here/generic_lib/macros/form">
                <metal:block fill-slot="content">
                  <metal:block
                    use-macro="here/generic_lib/macros/form_property">
                    <metal:block fill-slot="title"
                                 i18n:translate="_prop_comment_">
                      Comment
                    </metal:block>
                    <metal:block fill-slot="content">
                      <textarea name="comment" cols="40" rows="4"></textarea>
                    </metal:block>
                  </metal:block>
                </metal:block>
              </metal:block>
              <br />
              <select name="status"
                tal:define="
                  statuses python:['confirmed', 'tentative', 'decline', 'decline_and_delete', 'ignore'];
                  selected python:event['event_status'] == 'cancelled'
                    and 'ignore' or 'confirmed'">
                <option tal:repeat="status statuses"
                        tal:attributes="value status; selected python:status == selected"
                        tal:content="python:str('_cal_pending_%s_' % (status, ))"
                        i18n:translate="">
                  Confirm
                </option>
              </select>
              <input type="submit" name="calendar_confirmPendingEvent:method"
                tal:attributes="value python:str('_button_validate_')" />
            </tal:block>
          </tal:block>
        </tal:block>
        <tal:block condition="python:request == 'status'">
          <h3 i18n:translate="_cal_Status_update_">
            Status update
          </h3>
          <ul>
            <li tal:repeat="attendee pending/change">
              <strong tal:content="attendee/cn|attendee/id">Attendee</strong>
              (<tal:block content="python:str('_cal_status_%s_' % (attendee['status'], ))"
                          i18n:translate="" />)
              <p tal:condition="attendee/comment|nothing">
                <strong tal:content="attendee/sender_cn|attendee/sender|nothing">
                  sender
                </strong>:
                <em tal:content="attendee/comment">comment</em>
              </p>
              <p tal:condition="not:attendee/comment|nothing">
                <strong i18n:translate="_cal_Sender:">
                  Sender:
                </strong>
                <tal:block replace="attendee/sender_cn|attendee/sender|nothing">
                  sender
                </tal:block>
              </p>
            </li>
          </ul>
          <input type="submit" name="confirmPendingEvent:method"
                 tal:attributes="value python:str('_button_validate_')"
                 i18n:attributes="value" />
        </tal:block>
      </tal:block>
    </form>
  </tal:block>
</metal:block>

<metal:block define-macro="notifyattendees"
             i18n:domain="cpscalendar">
  <tal:block condition="python:mtool.checkPermission('Add portal content', here)">
    <tal:block define="pendings here/getPendingEvents"
      condition="pendings">
      You have pending requests for this event:
      <metal:block use-macro="here/calendar_macros/macros/pendings_view" />
    </tal:block>
    <tal:block condition="python:here.canEditThisEvent() and here.attendees and here.isdirty">
      <h3 i18n:translate="_You have to notify other attendees of recent changes to this event_">
        You have to notify other attendees of recent changes to this event.
      </h3>
      <form action="updateAttendeesCalendars"
        tal:define="notified_attendees here/notified_attendees">
        <ul>
          <li tal:repeat="att here/attendees">
            <input type="checkbox" name="attendees:list"
              tal:attributes="
              value att/id; checked python:att['id'] not in notified_attendees" />
            <tal:block replace="att/cn|att/id" />
          </li>
        </ul>
        <metal:block use-macro="here/generic_lib/macros/form">
          <metal:block fill-slot="content">
            <metal:block use-macro="here/generic_lib/macros/form_property">
              <metal:block fill-slot="title"
                           i18n:translate="_prop_comment_">
                Comment
              </metal:block>
              <metal:block fill-slot="content">
                <textarea name="comment" cols="40" rows="4"></textarea>
              </metal:block>
            </metal:block>
          </metal:block>
        </metal:block>
        <input type="submit"
               tal:attributes="value python:str('_button_validate_')"
               i18n:attributes="value" />
      </form>
    </tal:block>
  </tal:block>
</metal:block>
