<tal:block define="global current_action string:meeting" />
<html metal:use-macro="here/main_template/macros/master">

<metal:block fill-slot="script_plus"
  tal:content="structure here/day_selector_popup.js">
  Day selector popup script
</metal:block>

<metal:block fill-slot="header"
  tal:content="python:str('_Meeting creation helper_')">
  Meeting creation helper
</metal:block>

<metal:block fill-slot="header_plus" />

<metal:block fill-slot="main"
  tal:define="
    edit request/form/edit|nothing;
    disp_infos python:here.calendar_getDispInformations(request);
    selected_day disp_infos/selected_day;
    args python:edit and request.SESSION['meeting']['args'];
    from_date_year python:edit and int(args['from_date_year']) or selected_day.year();
    from_date_month python:edit and int(args['from_date_month']) or selected_day.month();
    from_date_day python:edit and int(args['from_date_day']) or selected_day.day();
    to_date_year python:edit and int(args['to_date_year']) or selected_day.year();
    to_date_month python:edit and int(args['to_date_month']) or selected_day.month();
    to_date_day python:edit and int(args['to_date_day']) or selected_day.day();
    from_date python:DateTime(from_date_year, from_date_month, from_date_day);
    to_date python:DateTime(to_date_year, to_date_month, to_date_day);
    from_date_hour python:(edit and [int(args['from_date_hour'])] or [9])[0];
    from_date_minute python:(edit and [int(args['from_date_minute'])] or [0])[0];
    to_date_hour python:(edit and [int(args['to_date_hour'])] or [17])[0];
    to_date_minute python:(edit and [int(args['to_date_minute'])] or [0])[0];
    my_id here/id;
    cal_ids python:edit and args['cal_ids'] or [my_id];
    user_types here/getUserTypes;
    all_calendars python:here.getCalendarsDict(exclude=my_id);"
  tal:on-error="python:request.RESPONSE.redirect('%s/calendar_meeting_expired' % (here.absolute_url(), ))">

  <form action="calendar_begin_meeting" method="POST">
    <h2
      tal:content="python:str('_Select the attendees you want for your meeting:')">
      Select the attendees you want for your meeting:
    </h2>
    <tal:block repeat="user_type user_types">
      <tal:block
        define="
          type_id user_type/id;
          calendars all_calendars/?type_id|nothing"
        condition="calendars">
        <h3 tal:content="python:str(user_type['plural_title'])">User type</h3>
        <ul>
          <li tal:repeat="cal calendars">
            <input type="checkbox" name="cal_ids:list"
              tal:define="
                id cal/id;
              "
              tal:attributes="
                value id;
                checked python:id in cal_ids;
              " />
            <tal:block replace="cal/cn">
              Calendar
            </tal:block>
          </li>
        </ul>
      </tal:block>
    </tal:block>
    <p>
      <small>
        <input type="checkbox" name="cal_ids:list"
          tal:attributes="
            value my_id;
            checked python:my_id in cal_ids;" />
        <tal:block replace="python:str('_Include this calendar_')">
          Include this calendar
        </tal:block>
      </small>
    </p>
    <h2
      tal:content="python:str('_Select the time interval you want for your meeting:')">
      Select the time interval you want for your meeting:
    </h2>
    <input type="hidden" id="from_date_day" name="from_date_day"
      tal:attributes="value from_date_day" />
    <input type="hidden" id="from_date_month" name="from_date_month"
      tal:attributes="value from_date_month" />
    <input type="hidden" id="from_date_year" name="from_date_year"
      tal:attributes="value from_date_year" />
    <input type="hidden" id="to_date_day" name="to_date_day"
      tal:attributes="value to_date_day" />
    <input type="hidden" id="to_date_month" name="to_date_month"
      tal:attributes="value to_date_month" />
    <input type="hidden" id="to_date_year" name="to_date_year"
      tal:attributes="value to_date_year" />
    <h3>
      <tal:block replace="python:str('_cal_date_From_')">
        From
      </tal:block>
      <span id="from_date_string">
        <tal:block replace="python:str('_cal_Day_long%s' % (from_date.dow(), ))" />
        <tal:block replace="from_date_day" />
        <tal:block replace="python:str('_cal_Month%s' % (from_date_month, ))" />
        <tal:block replace="from_date_year" />
      </span>
      <a tal:define="int_date python:int(from_date);"
        tal:attributes="href string:javascript:open_day_selector('${int_date}', '\'from_date\'', '\'from_date_string\'', '\'\'')
        ">
        <img border="0"
          tal:attributes="src string:${portal_url}/day_selector_icon.png" />
      </a>
    </h3>
    <h3>
      <tal:block replace="python:str('_cal_date_To_')">
        To
      </tal:block>
      <span id="to_date_string">
        <tal:block replace="python:str('_cal_Day_long%s' % (to_date.dow(), ))" />
        <tal:block replace="to_date_day" />
        <tal:block replace="python:str('_cal_Month%s' % (to_date_month, ))" />
        <tal:block replace="to_date_year" />
      </span>
      <a
        tal:define="
          int_date python:int(to_date);
        "
        tal:attributes="
          href string:javascript:open_day_selector('${int_date}', '\'to_date\'', '\'to_date_string\'', '\'\'')
          ">
        <img border="0"
          tal:attributes="src string:${portal_url}/day_selector_icon.png" />
      </a>
    </h3>
    <input type="hidden" name="from_date_hour" id="from_date_hour"
      tal:attributes="value from_date_hour" />
    <input type="hidden" name="from_date_minute"
      id="from_date_minute"
      tal:attributes="value from_date_minute" />
    <input type="hidden" name="to_date_hour" id="to_date_hour"
      tal:attributes="value to_date_hour" />
    <input type="hidden" name="to_date_minute"
      id="to_date_minute"
      tal:attributes="value to_date_minute" />
    <h3>
      <tal:block replace="python:str('_cal_Between_')">
        Between
      </tal:block>
      <span id="from_date_hour_s"
        tal:content="from_date_hour">10</span><tal:block replace="python:str('_cal_hour_sep_')">:</tal:block><span id="from_date_minute_s"
        tal:content="python:from_date_minute == 0 and '00' or from_date_minute">10</span>
      <tal:block replace="python:str('_(Between date)_and_')">
        and
      </tal:block>
      <span id="to_date_hour_s"
        tal:content="to_date_hour">10</span><tal:block replace="python:str('_cal_hour_sep_')">:</tal:block><span id="to_date_minute_s"
        tal:content="python:to_date_minute == 0 and '00' or to_date_minute">10</span>
      <a
        tal:define="
          a_start python:from_date_hour*4+from_date_minute/15;
          a_end python:to_date_hour*4+to_date_minute/15-1;"
        tal:attributes="
        href string:javascript:open_interval_selector(${a_start}, ${a_end}, 0, 0, 96)">
        <img border="0"
          tal:attributes="src string:${portal_url}/interval_selector_icon.png" />
      </a>
    </h3>
    <h2
      tal:content="python:str('_Select the desired duration of your meeting:')">
      Select the desired duration of your meeting:
    </h2>
    <p>
      <select name="duration_hour:int">
        <option tal:repeat="hour python:range(0,24)"
          tal:content="hour" tal:attributes="value hour;
            selected python:hour == 1 or nothing" />
      </select><tal:block replace="python:str('_cal_hour_sep_')">:</tal:block><select name="duration_minute:int">
        <option tal:repeat="minute python:range(0,60,15)"
          tal:content="minute" tal:attributes="value minute;
            selected python:minute == 0 or nothing" />
      </select>
    </p>
    <input type="submit"
      tal:attributes="value python:str('_button_search_')" />
    <input type="button" onClick="history.back()"
      tal:attributes="value python:str('_button_cancel_')" />
  </form>
</metal:block>
</html>
