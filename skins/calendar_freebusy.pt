<tal:block define="global current_action string:meeting" />
<html metal:use-macro="here/main_template/macros/master">

<metal:block fill-slot="style_plus">
  <link rel="stylesheet" type="text/css"
    tal:attributes="href string:${portal_url}/calendar_stylesheet.css" />
</metal:block>

<metal:block fill-slot="header"
  tal:content="python:str('_Meeting creation helper_')">
    Meeting creation helper
</metal:block>

<metal:block fill-slot="header_plus" />

<metal:block fill-slot="main"
  tal:define="
    meeting request/SESSION/meeting;
    freebusy_infos meeting/freebusy_infos;
    slots freebusy_infos/slots;
    len_slots python:len(slots);
    slot_start request/SESSION/freebusy_start;
    first_day python:slots[slot_start][0];
    first_dow first_day/dow;
    first_dow python:first_dow == 0 and 7 or first_dow;
    disp_start python:slot_start - (first_dow - 1);
    slot_end python:slot_start + 7 > len_slots and len_slots or slot_start + 7;
    slot_end python:slot_end > disp_start + 7 and disp_start + 7 or slot_end;
    disp_end python:disp_start+7;
    busy_infos meeting/busy_infos;
    hour meeting/args/duration_hour;
    minute meeting/args/duration_minute;
    desired_height python:hour*60+minute;
    back_td1 string:${portal_url}/cal_line1.png;
    back_td2 string:${portal_url}/cal_line2.png;
    empty_src string:${portal_url}/cal_empty.gif;
    "
    tal:on-error="python:request.RESPONSE.redirect('%s/calendar_meeting_expired' % (here.absolute_url(), ))">
  <table cellspacing="0" cellpadding="0" border="0" width="100%">
    <tr>
      <td>
        <table height="15" align="right"
          cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td width="30" class="cal_left_tab">
              <tal:block condition="python:disp_start > 0">
                <a class="cal_event"
                  tal:define="
                    prev python:disp_start - 7;
                  "
                  tal:attributes="href string:calendar_go_freebusy?start=${prev}">
                  <<
                </a>
              </tal:block>
            </td>
            <td width="30" class="cal_right_tab">
              <tal:block condition="python:disp_end < len_slots">
                <a class="cal_event"
                  tal:define="
                    next python:disp_start + 7;
                  "
                  tal:attributes="href string:calendar_go_freebusy?start=${next}">
                  >>
                </a>
              </tal:block>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td>
        <table width="452" cellspacing="0" cellpadding="0" border="1">
          <tr>
            <td>
              <table width="452" cellspacing="2" cellpadding="0" border="0">
                <tr>
                  <td>
                  </td>
                  <td width="59" bgcolor="#DDDDDD"
                    tal:repeat="i python:range(disp_start, slot_start)">
                  </td>
                  <th width="59"
                    tal:repeat="i python:range(slot_start, slot_end)">
                    <tal:block
                      define="
                        dow python:str('_cal_Day%s' % (i - slot_start + first_dow - 1));
                        date python:slots[i][0];
                        dom date/day;
                        month python:str('_cal_Mo%s' % date.month());
                      "
                      tal:content="string:${dow} ${dom} ${month}" />
                  </th>
                  <td width="59" bgcolor="#DDDDDD"
                    tal:repeat="i python:range(slot_end, disp_end)">
                  </td>
                </tr>
                <tr>
                  <td width="25" valign="top" bgcolor="#DDDDDD">
                    <table cellspacing="0" cellpadding="0" border="0">
                      <tr>
                        <td height="5">
                        </td>
                      </tr>
                      <tr tal:repeat="i python:range(1,25)">
                        <td height="15" valign="bottom"
                          tal:define="h python:i<24 and i or '00'"
                          tal:content="string:${h}:00">
                        </td>
                      </tr>
                    </table>
                  </td>
                  <td width="59" bgcolor="#DDDDDD"
                    tal:repeat="i python:range(disp_start, slot_start)">
                  </td>
                  <tal:block
                    repeat="busy_day python:busy_infos[slot_start:slot_end]">
                    <td with="59" height="365" valign="top"
                      tal:define="even repeat/busy_day/even"
                      tal:attributes="
                        background python:even and back_td2 or back_td1">
                      <table cellspacing="0" cellpadding="0" width="59" border="0">
                        <tr tal:repeat="block busy_day">
                          <td width="59"
                            tal:define="
                              height block/height;
                              busy block/busy;
                              ok python:not busy and height >= desired_height;
                              disp_height python:height/4;"
                            tal:attributes="
                              height disp_height;
                              bgcolor python:(busy and '#AAAAAA') or (ok and '#00FF00') or nothing">
                            <tal:block condition="ok">
                              <a
                                tal:define="
                                  time python:int(block['start']);"
                                tal:attributes="
                                  title python:str('_Create the meeting here_');
                                  href string:create_meeting_form?time=${time}&window=${height}">
                                <img width="59" border="0"
                                  tal:attributes="
                                    height disp_height;
                                    src empty_src;" />
                              </a>
                            </tal:block>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tal:block>
                  <td width="59" bgcolor="#DDDDDD"
                    tal:repeat="i python:range(slot_end, disp_end)">
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        <table cellspacing="2" cellpadding="0">
          <tr>
            <td bgcolor="#00FF00" width="40">
            </td>
            <td
              tal:content="python:str('_Period of free time you can use to create your meeting_')">
              Period of free time you can use to create your meeting
            </td>
          </tr>
          <tr>
            <td bgcolor="#AAAAAA" width="40">
            </td>
            <td
              tal:content="python:str('_Busy time_')">
              Busy time
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
  <h3
    tal:content="python:str('_Calendar selection_')">
    Calendar selection
  </h3>
  <p
    tal:content="python:str('_You can unselect some calendars if you want_')">
    You can unselect some calendars if you want.
  </p>
  <form action="calendar_meeting_ids" method="POST">
    <ul
      tal:define="
        cal_users meeting/freebusy_infos/cal_users;
        selected_users meeting/display_ids;">
      <li tal:repeat="user cal_users/items">
        <input type="checkbox" name="cal_ids:list"
          tal:attributes="
            value python:user[0];
            checked python:user[0] in selected_users;
          " />
        <tal:block replace="python:user[1]" />
      </li>
    </ul>
    <input type="submit"
      tal:attributes="value python:str('_button_validate_')" />
  </form>
  <form method="POST"
    tal:attributes="action here/absolute_url">
    <input type="hidden" name="edit" value="1" />
    <input type="submit" name="calendar_meeting_form:method"
      tal:attributes="value python:str('_Modify your request_')" />
    <input type="submit" name="calendar_meeting_cancel:method"
      tal:attributes="value python:str('_Cancel your request_')" />
  </form>
</metal:block>

</html>
