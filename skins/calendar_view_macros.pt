<metal:block define-macro="day">
  <tal:block
    condition="show_nav|python:1">
    [<a href="calendar_printable_view"
      target="_new"
      tal:content="python:mcat('_cal_Printable_view_')">
      Printable view
    </a>]
    <br />
    <a
      tal:define="
      prev_day python:int(viewed_day-1);"
      tal:attributes="
      href string:${here_url}?viewed_day=${prev_day}">
      &lt;&lt;
    </a>
    <a
      tal:define="
        today python:int(DateTime());"
      tal:attributes="
        href string:${here_url}?viewed_day=${today}"
      tal:content="python:mcat('_cal_Today_')">
      Today
    </a>
    <a
      tal:define="
      next_day python:int(viewed_day+1);"
      tal:attributes="
      href string:${here_url}?viewed_day=${next_day}">
      &gt;&gt;
    </a>
  </tal:block>
  <table cellspacing="0" cellpadding="0" border="1">
    <tr>
      <td>
        <table width="445" cellspacing="2" cellpadding="0" border="0"
          tal:define="
            empty_src string:${portal_url}/cal_empty.gif;
            event_src string:${portal_url}/cal_event;
            slots events_desc/slots;
            date python:slots[0][0];
            day_events events_desc/day_events;
            hour_blocks events_desc/hour_blocks">
          <tr>
            <td>
            </td>
            <th
              tal:define="
                dow python:mcat('_cal_Day_long%s' % date.dow());
                dom date/day;
                year date/year;
                month python:mcat('_cal_Month%s' % date.month());"
              tal:content="string:${dow} ${dom} ${month} ${year}" />
          </tr>
          <tr tal:repeat="day_event day_events">
            <td>
            </td>
            <td bgcolor="#DDDDDD"
              tal:define="event nocall:day_event/event">
              <a
                tal:attributes="href event/absolute_url"
                tal:content="event/title_or_id" />
            </td>
          </tr>
          <tr tal:condition="day_events">
            <td colspan="2" height="2" bgcolor="black">
            </td>
          </tr>
          <tr>
            <td valign="top" bgcolor="#DDDDDD">
              <table cellspacing="0" cellpadding="0" border="0">
                <tr>
                  <td height="5">
                  </td>
                </tr>
                <tr tal:repeat="i python:range(1,25)">
                  <td height="20" valign="bottom"
                    tal:define="h python:i<24 and i or '00'"
                    tal:content="string:${h}:00">
                  </td>
                </tr>
              </table>
            </td>
            <td width="445" height="480" valign="top"
              tal:attributes="background string:${portal_url}/cal_line.png">
              <tal:block repeat="block hour_blocks">
                <tal:block
                  define="conf_len python:len(block)">
                  <tal:block condition="python:conf_len == 1">
                    <tal:block define="
                      info python:block[0];
                      event nocall:info/event;
                      ">
                      <img width="445"
                        tal:condition="not:nocall:event"
                        tal:attributes="
                          src empty_src;
                          height python:info['height']/3" />
                      <table width="445" cellpadding="2" celspacing="0"
                        border="1"
                        tal:attributes="height python:info['height']/3"
                        tal:condition="nocall:event">
                        <tr>
                          <td valign="top"
                            tal:attributes="
                            background string:${event_src}_${event/event_status}.png">
                            <a
                              tal:attributes="
                                href event/absolute_url"
                                tal:content="event/title_or_id">
                              Event
                            </a>
                          </td>
                        </tr>
                      </table>
                    </tal:block>
                  </tal:block>
                  <tal:block condition="python:conf_len > 1">
                    <table cellpadding="0" cellspacing="0"
                      width="445" border="0"
                      tal:define="width python:445/conf_len">
                      <tr>
                        <td valign="top" tal:repeat="block_col block">
                          <tal:block repeat="info block_col">
                            <tal:block define="event nocall:info/event">
                              <img
                                tal:condition="not:nocall:event"
                                tal:attributes="
                                  border python:not not event;
                                  src empty_src;
                                  width width;
                                  height python:info['height']/3" />
                              <table cellpadding="2" celspacing="0"
                                border="1"
                                tal:attributes="
                                  width width;
                                  height python:info['height']/3"
                                tal:condition="nocall:event">
                                <tr>
                                  <td valign="top"
                                    tal:attributes="
                                    background string:${event_src}_${event/event_status}.png;">
                                    <a
                                      tal:attributes="
                                        href event/absolute_url"
                                        tal:content="event/title_or_id">
                                      Event
                                    </a>
                                  </td>
                                </tr>
                              </table>
                            </tal:block>
                          </tal:block>
                        </td>
                      </tr>
                    </table>
                  </tal:block>
                </tal:block>
              </tal:block>
            </td>
          </tr>
          <tr tal:condition="can_add_evts">
            <td>
            </td>
            <td>
              <a
                tal:define="intdate python:int(date)"
                tal:attributes="
                  href string:${here_url}/calendar_addevent_form?selected_day=${intdate}">
                <img border="0"
                  tal:attributes="
                  src string:${portal_url}/img_box_addbox.png" />
              </a>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</metal:block>

<metal:block define-macro="week">
  <tal:block
    condition="show_nav|python:1">
    [<a href="calendar_printable_view"
      target="_new"
      tal:content="python:mcat('_cal_Printable_view_')">
      Printable view
    </a>]
    <br />
    <a
      tal:define="
      prev_week python:int(viewed_day-7);"
      tal:attributes="
      href string:${here_url}?viewed_day=${prev_week}">
      &lt;&lt;
    </a>
    <a
      tal:define="
        today python:int(DateTime());"
      tal:attributes="
        href string:${here_url}?viewed_day=${today}"
      tal:content="python:mcat('_cal_Today_')">
      Today
    </a>
    <a
      tal:define="
      next_week python:int(viewed_day+7);"
      tal:attributes="
      href string:${here_url}?viewed_day=${next_week}">
      &gt;&gt;
    </a>
  </tal:block>
  <table cellspacing="0" cellpadding="0" border="1">
    <tr>
      <td>
        <table width="445" cellspacing="2" cellpadding="0" border="0"
          tal:define="
            empty_src string:${portal_url}/cal_empty.gif;
            event_src string:${portal_url}/cal_event;
            back_td1 string:${portal_url}/cal_line1.png;
            back_td2 string:${portal_url}/cal_line2.png;
            add_src string:${portal_url}/img_box_addbox.png;
            add_url string:${here_url}/calendar_addevent_form?selected_day=;
            slots events_desc/slots;
            day_lines events_desc/day_lines;
            hour_block_cols events_desc/hour_block_cols">
          <tr>
            <td>
            </td>
            <th width="59" tal:repeat="i python:range(0,7)">
              <a
                tal:define="
                  dow python:mcat('_cal_Day%s' % i);
                  date python:slots[i][0];
                  dom date/day;
                  month python:mcat('_cal_Mo%s' % date.month());
                  go_day python:int(date);
                "
                tal:attributes="
                  href string:${here_url}?disp=day&viewed_day=${go_day}"
                tal:content="string:${dow} ${dom} ${month}" />
            </th>
          </tr>
          <tr tal:repeat="line day_lines">
            <td>
            </td>
            <tal:block repeat="col line">
              <td
                tal:define="colspan col/colspan"
                tal:attributes="
                colspan python:colspan> 1 and colspan or nothing;
                bgcolor python:col['event'] and '#DDDDDD'">
                <tal:block condition="nocall:col/event">
                  <a
                    tal:define="
                      event nocall:col/event;
                      title event/title_or_id;
                      max_chars python:10*colspan-1;
                      disp_title python:len(title)>max_chars and
                        title[:max_chars].strip()+'...' or title"
                      tal:attributes="
                        href event/absolute_url;
                        title title;"
                        tal:content="disp_title" />
                </tal:block>
              </td>
            </tal:block>
          </tr>
          <tr tal:condition="day_lines">
            <td colspan="8" bgcolor="black" height="1">
            </td>
          </tr>
          <tr>
            <td valign="top" bgcolor="#DDDDDD">
              <table cellspacing="0" cellpadding="0" border="0">
                <tr>
                  <td height="5">
                  </td>
                </tr>
                <tr tal:repeat="i python:range(1,25)">
                  <td height="15" valign="bottom"
                    tal:define="h python:i<24 and i or '00'"
                    tal:content="string:${h}:00">
                  </td>
                </tr>
              </table>
            </td>
            <tal:block repeat="col hour_block_cols">
              <td width="59" height="360" valign="top"
                tal:define="even repeat/col/even"
                tal:attributes="
                background python:even and back_td2 or back_td1">
                <tal:block repeat="block col">
                  <tal:block
                    define="conf_len python:len(block)">
                    <tal:block condition="python:conf_len == 1">
                      <tal:block define="
                        info python:block[0];
                        event nocall:info/event;
                        src python:event and ('%s_%s.png' % (event_src, event.event_status)) or empty_src;
                        ">
                        <a
                          tal:omit-tag="not:nocall:event"
                          tal:attributes="
                            title python:event and '%s (%s - %s)' % (event.title_or_id(), event.from_date.strftime('%H:%M'), event.to_date.strftime('%H:%M'));
                            href python:event and event.absolute_url()">
                          <img
                            tal:define="
                              border python:not not event;"
                            tal:attributes="
                              border border;
                              src src;
                              width python:59 - border*2;
                              height python:info['height']/4 - 2*border" />
                        </a>
                      </tal:block>
                    </tal:block>
                    <tal:block condition="python:conf_len > 1">
                      <table cellpadding="0" cellspacing="0"
                        width="59" border="0"
                        tal:define="width python:59/conf_len">
                        <tr>
                          <td valign="top" tal:repeat="block_col block">
                            <tal:block repeat="info block_col">
                              <a
                                tal:define="
                                  event nocall:info/event;
                                  src python:event and ('%s_%s.png' % (event_src, event.event_status)) or empty_src;
                                  "
                                tal:omit-tag="not:nocall:event"
                                tal:attributes="
                                title python:event and '%s (%s -> %s)' % (event.title_or_id(), event.from_date.strftime('%H:%M'), event.to_date.strftime('%H:%M'));
                                  href python:event and event.absolute_url()">
                                <img
                                  tal:define="
                                    border python:not not event;"
                                  tal:attributes="
                                    border border;
                                    src src;
                                    width python:width - border*2;
                                    height python:info['height']/4 - 2*border" />
                              </a>
                            </tal:block>
                          </td>
                        </tr>
                      </table>
                    </tal:block>
                  </tal:block>
                </tal:block>
              </td>
            </tal:block>
          </tr>
          <tr tal:condition="can_add_evts">
            <td>
            </td>
            <td tal:repeat="slot slots">
              <a
                tal:attributes="
                  href python:add_url + str(int(slot[0]))">
                <img border="0"
                  tal:attributes="src add_src" />
              </a>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</metal:block>

<metal:block define-macro="month">
  <h2
    tal:define="
      month python:mcat('_cal_Month%s' % (viewed_day.month(), ));
      year viewed_day/year"
    tal:content="string:${month} ${year}" />
  <tal:block
    condition="show_nav|python:1">
    [<a href="calendar_printable_view"
      target="_new"
      tal:content="python:mcat('_cal_Printable_view_')">
      Printable view
    </a>]
    <br />
    <a
      tal:define="
      prev_month python:int(start_time-5);"
      tal:attributes="
      href string:${here_url}?viewed_day=${prev_month}">
      &lt;&lt;
    </a>
    <a
      tal:define="
        today python:int(DateTime());"
      tal:attributes="
      href string:${here_url}?viewed_day=${today}"
      tal:content="python:mcat('_cal_Today_')">
      Today
    </a>
    <a
      tal:define="
      next_month python:int(end_time+7);"
      tal:attributes="
      href string:${here_url}?viewed_day=${next_month}">
      &gt;&gt;
    </a>
  </tal:block>
  <table width="445" cellspacing="0" cellpadding="0" border="1">
    <tr>
      <td>
        <table width="445" cellspacing="2" cellpadding="0" border="0">
          <tr>
            <th
              tal:repeat="i python:[1,2,3,4,5,6,0]"
              tal:content="python:mcat('_cal_Day_long%s' % (i, ))">
              Mon
            </th>
          </tr>
          <tal:block repeat="line events_desc/lines">
            <tr>
              <tal:block repeat="events line/hour_cols">
                <td width="59"
                  tal:condition="not:events">
                </td>
                <tal:block condition="events">
                  <td width="59" valign="top"
                    tal:define="
                        day_height events/day_height;
                        slot events/slot;
                        go_day python:int(slot[0]);
                        even repeat/events/even"
                    tal:attributes="
                      bgcolor python:even and '#DDDDFF' or '#EEEEFF'
                      ">
                      <a tal:attributes="
                        href string:${here_url}?disp=day&viewed_day=${go_day}">
                        <strong tal:content="events/dom">1</strong>
                      </a>
                  </td>
                </tal:block>
              </tal:block>
            </tr>
            <tr tal:condition="line/day_lines">
              <td bgcolor="black" height="1" colspan="7">
              </td>
            </tr>
            <tr tal:repeat="day_line line/day_lines">
              <tal:block repeat="col day_line">
                <td
                  tal:define="colspan col/colspan"
                  tal:attributes="
                  colspan python:colspan > 1 and colspan or nothing;
                  bgcolor python:col['event'] and '#DDDDDD'">
                  <tal:block condition="nocall:col/event">
                    <a
                      tal:define="
                      event nocall:col/event;
                      title event/title_or_id;
                      max_chars python:10*colspan-1;
                      disp_title python:len(title)>max_chars and
                        title[:max_chars].strip()+'...' or title"
                      tal:attributes="
                      href event/absolute_url;
                      title title"
                      tal:content="disp_title" />
                  </tal:block>
                </td>
              </tal:block>
            </tr>
            <tr tal:condition="line/day_lines">
              <td bgcolor="black" height="1" colspan="7">
              </td>
            </tr>
            <tr>
              <tal:block repeat="events line/hour_cols">
                <td width="59"
                  tal:condition="not:events">
                </td>
                <tal:block condition="events">
                  <td width="59" valign="top"
                    tal:define="
                        day_height events/day_height;
                        even repeat/events/even"
                    tal:attributes="
                      bgcolor python:even and '#DDDDFF' or nothing
                      ">
                    <li tal:repeat="hour_event events/hour">
                      <a
                        tal:define="
                        event nocall:hour_event/event;
                        title python:'%s (%s - %s)' % (event.title_or_id(), event.from_date.strftime('%H:%M'), event.to_date.strftime('%H:%M'));
                        disp_title python:len(title) > 5 and (title[:5] + '...') or title;
                        "
                        tal:attributes="
                          title title;
                          href event/absolute_url"
                        tal:content="disp_title">
                        Event
                      </a>
                    </li>
                    <br
                      tal:define="
                        compense_height python:5 - day_height;
                      "
                      tal:condition="python:compense_height > 0"
                      tal:repeat="i python:range(0, compense_height)" />
                  </td>
                </tal:block>
              </tal:block>
            </tr>
            <tr tal:condition="not:repeat/line/end">
              <td colspan="7" bgcolor="black" height="2">
              </td>
            </tr>
          </tal:block>
        </table>
      </td>
    </tr>
  </table>
</metal:block>
