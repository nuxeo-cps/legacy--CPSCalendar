<tal:block define="create options/create|nothing;
           current_action python:create and 'addevent' or 'edit'">
<html metal:use-macro="here/main_template/macros/master">

<metal:block fill-slot="css_slot">
  <style type="text/css"
    tal:content="string:@import url(${base_url}calendar-win2k-1.css);"></style>
  <script type="text/javascript" src="calendar.js"
    tal:attributes="src string:${base_url}calendar.js"></script>

  <script type="text/javascript" src="lang/calendar-en.js"
    tal:define="local cpsmcat/get_selected_language"
    tal:attributes="src string:${base_url}lang/calendar-${local}.js"></script>
  <script type="text/javascript" src="calendar-setup.js"
    tal:attributes="src string:${base_url}calendar-setup.js"></script>
</metal:block>

<metal:block fill-slot="main" i18n:domain="cpscalendar"
         tal:define="portal_url here/portal_url;
             disp_infos python:here.calendar_getDispInformations(request);
             action python:create and 'calendar_addevent' or 'calendar_editevent';
             submit_value python:create and str('cpscalendar_button_create') or str('cpscalendar_button_modify');
             editevent python:create or here.canEditThisEvent();
             title python:create and request.form.get('title',
                                                      'cpscalendar_untitled_(document)')
                                 or here.title;
             description python:create and str('') or here.description;
             location python:(not create) and here.location or '';
             event_status python:create and 'unconfirmed' or here.event_status;
             here_all_day here/all_day|python:0;
             all_day python:test(create, request.form.get('all_day', 0), here_all_day);
             from_date here/from_date|python:disp_infos['selected_day'];
             from_date_day from_date/day;
             from_date_month from_date/month;
             from_date_year from_date/year;
             from_date_hour from_date/hour;
             from_date_string python:here.getDateStr(from_date, fmt='short');
             from_date_hour python:create and not all_day and (from_date_hour + 14) or from_date_hour;
             from_date_minute python:int(from_date.minute()/15)*15;
             to_date python:create and from_date or here.to_date;
             to_date_day to_date/day;
             to_date_month to_date/month;
             to_date_year to_date/year;
             to_date_hour to_date/hour;
             to_date_string python:here.getDateStr(to_date, fmt='short');
             to_date_hour python:(create and not all_day and (from_date_hour + 2)) or to_date_hour;
             trim_hour python:create and not all_day and to_date_hour > 23;
             to_date_minute python:int(to_date.minute()/15)*15;
             to_date_hour python:not trim_hour and to_date_hour or 0;
             to_date_minute python:not trim_hour and to_date_minute or 0;
             attendees python:(not create) and here.attendees or [];
             transparent python:not create and not not here.transparent or 0;
             cat_info here/calendar_categories;
             categories cat_info/categories;
             cat_default cat_info/default;
             category python:create and cat_default or here.category;">

      <tal:block tal:condition="nothing">
    <!-- Debug block that doesn't appear in the output -->
    <hr>
    <p>
    here/all_day = <tal:block tal:replace="here/all_day|nothing"/><br>
    form.get('all_day') = <tal:block tal:replace="python:request.form.get('all_day')"/><br>
    here/title = <tal:block tal:replace="here/title|nothing"/><br>
    form.get('title') = <tal:block tal:replace="python:request.form.get('title')"/><br>
    </p>
    <hr>
      </tal:block>

     <h1>
       <tal:block condition="create"
                  i18n:translate="cpscalendar_description_create_a_new_event">
         Create a new event
       </tal:block>
       <tal:block condition="not:create">
         <span i18n:translate="cpscalendar_description_modify_event">
           Modify the event
         </span>
         «&nbsp;<span tal:replace="here/title_or_id">Title</span>&nbsp;»
       </tal:block>
     </h1>

  <tal:block condition="not:editevent"
             define="event nocall:here">
    <metal:block use-macro="here/calendar_macros/macros/event_view" />
  </tal:block>

  <tal:block condition="editevent">

    <form action="calendar_addevent_form" id="eventTypeForm"
      tal:condition="create">
      <p>
      <input type="hidden" name="all_day:int"
             tal:attributes="value not:all_day">
      <input type="hidden" name="from_date:int"
             tal:attributes="value from_date/timeTime">
      <input type="hidden" name="title" id="rememberTitle"
             tal:attributes="value title">
      <input type="submit"
             tal:attributes="value python:
                             all_day and str('cpscalendar_create_all_day_event')
                                or str('cpscalendar_create_not_all_day_event');"
             i18n:attributes="value">
      </p>
    </form>
    <form action="calendar_changeeventtype" id="eventTypeForm"
      tal:condition="not:create">
      <p>
      <input type="hidden" name="all_day:int"
             tal:attributes="value not:all_day">
      <input type="submit"
             tal:attributes="value python:
                             all_day and str('cpscalendar_change_event_to_not_all_day')
                                     or str('cpscalendar_change_event_to_all_day');"
             i18n:attributes="value">
      </p>
    </form>

    <form tal:attributes="action action" method="POST">
      <metal:block use-macro="here/calendar_macros/macros/form">
    <metal:block fill-slot="content">
      <metal:block use-macro="here/calendar_macros/macros/form_property">
        <metal:block fill-slot="title"
                     i18n:translate="cpscalendar_label_title">
          Title
        </metal:block>
        <metal:block fill-slot="content">
          <input name="title" size="40"
                 tal:attributes="value title;
                     onchange string:document.getElementById('rememberTitle').value = this.value"
                 i18n:attributes="value">
        </metal:block>
      </metal:block>
      <metal:block use-macro="here/calendar_macros/macros/form_property">
        <metal:block fill-slot="title"
                     i18n:translate="cpscalendar_label_date">
          Date
        </metal:block>
        <metal:block fill-slot="content">
          <strong>
          <tal:block condition="all_day">
          <input type="hidden" name="all_day" value="on">
          <input type="hidden" name="from_date_hour"
                 tal:attributes="value from_date_hour" />
          <input type="hidden" name="from_date_minute"
                 tal:attributes="value from_date_minute" />
          <input type="hidden" name="to_date_hour"
                 tal:attributes="value to_date_hour" />
          <input type="hidden" name="to_date_minute"
                 tal:attributes="value to_date_minute" />
          <span i18n:translate="cpscalendar_label_from_day">
            From the
          </span>
          <input type="text" size="11" maxlength="22"
                 tal:attributes="name string:from_date;
                                 id string:from_date;
                                 value from_date_string;" />
            <button id="trigger"
                    tal:attributes="id string:trigger_from_date">...</button>
            <tal:block define="fmt python:here.Localizer.default('jscalendar_date_fmt');"
                       replace="structure string:<script type='text/javascript'>
Calendar.setup(
{
inputField  : 'from_date',
ifFormat    : ${fmt},
button      : 'trigger_from_date',
mondayFirst : true,
range       : [2000, 2049]
}
);
</script>" />
            <span i18n:translate="cpscalendar_label_to_day">
              to
            </span>
            <input type="text" size="11" maxlength="22"
                   tal:attributes="name string:to_date;
                                   id string:to_date;
                                   value to_date_string;" />
            <button id="trigger"
                    tal:attributes="id string:trigger_to_date">...</button>
            <tal:block define="fmt python:here.Localizer.default('jscalendar_date_fmt');"
                       replace="structure string:<script type='text/javascript'>
Calendar.setup(
{
inputField  : 'to_date',
ifFormat    : ${fmt},
button      : 'trigger_to_date',
mondayFirst : true,
range       : [2000, 2049]
}
);
</script>" />
            </tal:block>
            <tal:block condition="not:all_day"
                       tal:define="multi_day_event python:from_date_string != to_date_string;">

              <input type="hidden" id="to_date" name="to_date"
                     tal:attributes="value to_date_string" />
              <input type="text" size="11" maxlength="22"
                     tal:attributes="name string:from_date;
                                     id string:from_date;
                                     value from_date_string;" />
              <button id="trigger"
                      tal:attributes="id string:trigger_from_date">...</button>
              <tal:block define="fmt python:here.Localizer.default('jscalendar_date_fmt');"
                         replace="structure string:<script type='text/javascript'>
Calendar.setup(
{
inputField  : 'from_date',
ifFormat    : 'd/m/y',
button      : 'trigger_from_date',
mondayFirst : true,
range       : [2000, 2049]
}
);
</script>" />
              <br>
              <span i18n:translate="cpscalendar_label_from_hour">From</span>
              <select name="from_date_hour:int">
                <option tal:repeat="hour python:range(0,24)"
                        tal:content="hour"
                        tal:attributes="value hour;
                                        selected python:hour == from_date_hour;" />
              </select>
              <span i18n:translate="cpscalendar_hour_sep">:</span>
              <select name="from_date_minute:int">
                <option tal:repeat="minute python:range(0,60,5)"
                        tal:content="minute"
                        tal:attributes="value minute;
                                        selected python:minute == from_date_minute;" />
              </select>
              <span i18n:translate="cpscalendar_label_to_hour">to</span>
              <select name="to_date_hour:int">
                <option tal:repeat="hour python:range(0,24)"
                        tal:content="hour"
                        tal:attributes="value hour;
                                        selected python:hour == to_date_hour;" />
              </select>
              <span i18n:translate="cpscalendar_hour_sep">:</span>
              <select name="to_date_minute:int">
                <option tal:repeat="minute python:range(0,60,5)"
                        tal:content="minute"
                        tal:attributes="value minute;
                                        selected python:minute == to_date_minute;" />
              </select>

              <tal:block condition="nothing">
                (<tal:block content="string:cpscalendar_label_day_long${to_date/dow}"
                           i18n:translate="" />
                <tal:block replace="to_date_day" />
                <tal:block content="string:cpscalendar_label_month_long${to_date_month}"
                           i18n:translate="" />
                <tal:block replace="to_date_year" />)
              </tal:block>

            </tal:block>
          </strong>
        </metal:block>
      </metal:block>
      <metal:block use-macro="here/calendar_macros/macros/form_property">
        <metal:block fill-slot="title"
             i18n:translate="cpscalendar_label_location">
          Location
        </metal:block>
        <metal:block fill-slot="content">
          <input name="location" size="40" tal:attributes="value location" />
        </metal:block>
      </metal:block>
      <metal:block use-macro="here/calendar_macros/macros/form_property">
        <metal:block fill-slot="title"
             i18n:translate="cpscalendar_label_eventstatus">
          Event status
        </metal:block>
        <metal:block fill-slot="content">
          <select name="event_status"
              tal:define="statuses python:['confirmed', 'unconfirmed', 'cancelled'];
                  statuses python:create and [status for status in statuses if status != 'cancelled'] or statuses">
        <option tal:repeat="status statuses"
                tal:attributes="value status;
                                selected python:status == event_status;">
              <span tal:content="string:cpscalendar_option_status_${status}"
                    i18n:translate="">cpscalendar_status</span>
        </option>
          </select>
        </metal:block>
      </metal:block>
      <metal:block use-macro="here/calendar_macros/macros/form_property">
        <metal:block fill-slot="title"
             i18n:translate="cpscalendar_label_category">
              Category
        </metal:block>
        <metal:block fill-slot="content">
          <table width="100%" cellspacing="2" cellpadding="0" border="0">
        <tr tal:repeat="cat categories/items">
          <td width="30" valign="middle">
            <input type="radio" name="category"
               tal:attributes="value python:cat[0];
                       checked python:cat[0] == category;" />
          </td>
          <td width="30" valign="middle">
            <table cellpadding="0" cellspacing="0" width="80%"
               height="10" border="0"
               tal:attributes="bgcolor python:cat[1]['color']">
              <tr>
            <td>
            </td>
              </tr>
            </table>
          </td>
          <td valign="middle"
          tal:content="python:str(cat[1]['title'])"
          i18n:translate="">
            category
          </td>
        </tr>
          </table>
        </metal:block>
      </metal:block>

      <metal:block use-macro="here/calendar_macros/macros/form_property">
        <metal:block fill-slot="title"
             i18n:translate="cpscalendar_label_transparent">
          Transparent
        </metal:block>
        <metal:block fill-slot="content">
          <select name="transparent:int"
              tal:define="choices python:[{'id': 1, 'title': 'cpscalendar_option_yes'}, {'id':0, 'title': 'cpscalendar_option_no'}]">
        <option tal:repeat="choice choices"
            tal:attributes="value choice/id;
                    selected python:transparent == choice['id']"
            tal:content="python:str(choice['title'])"
            i18n:translate="">
          Yes
        </option>
        <p>
          <small i18n:translate="cpscalendar_legend_transparent">
            Transparent events mean that you're not busy during this event.
          </small>
        </p>
          </select>
        </metal:block>
      </metal:block>

      <metal:block use-macro="here/calendar_macros/macros/form_property">
        <metal:block fill-slot="title"
             i18n:translate="cpscalendar_label_description">
          Description
        </metal:block>
        <metal:block fill-slot="content">
          <p>
        <textarea rows="6" cols="40"
              name="description"
              tal:content="description">description</textarea>
          </p>
        </metal:block>
      </metal:block>

      <tal:block condition="nothing">
      <metal:block use-macro="here/calendar_macros/macros/form_property">
        <metal:block fill-slot="title"
             i18n:translate="cpscalendar_label_repeat_title">
          Repeat
        </metal:block>
        <metal:block fill-slot="content">
          <input name="repeat:bool" type="checkbox" />
          <br>
          <span i18n:translate="cpscalendar_label_repeat_times">Number of times</span>
          &nbsp;&nbsp;
          <input type="string" name="cpscalendar_form_repeat_times:int"
             size="2" maxlength="2" value="0"/>
        <br><input type="radio" name="repeat_frequency" value="daily">
        <span i18n:translate="cpscalendar_label_repeat_daily">Daily</span>
        <br><input type="radio" name="repeat_frequency" value="weekly">
        <span i18n:translate="cpscalendar_label_repeat_weekly">Weekly</span>
        <br><input type="radio" name="repeat_frequency" value="monthly">
        <span i18n:translate="cpscalendar_label_repeat_monthly">Monthly</span>
        <br><input type="radio" name="repeat_frequency" value="X_days">
        <span i18n:translate="cpscalendar_label_repeat_every_X_days_begin">Every</span>
          &nbsp;
          <input type="string" name="cal_every_X_num:int"
             size="3" maxlength="3" value="0"/>&nbsp;
        <span i18n:translate="cpscalendar_label_repeat_every_X_days_end">days</span>
        </metal:block>
      </metal:block>
      </tal:block>

    </metal:block>
      </metal:block>
      <input type="submit"
                   tal:attributes="value submit_value"
                   i18n:attributes="value"/>
      <input type="button" onClick="history.back()"
         value="cpscalendar_button_cancel"
         i18n:attributes="value"/>
    </form>
  </tal:block>
  <form action="setMyStatus" tal:condition="python:not (create or editevent)">
    <strong i18n:translate="cpscalendar_label_modify_event_status">
      Modify status for this event
    </strong>:
    <metal:block use-macro="here/calendar_macros/macros/form">
      <metal:block fill-slot="content">
    <metal:block use-macro="here/calendar_macros/macros/form_property">
      <metal:block fill-slot="title"
               i18n:translate="cpscalendar_label_status">
        Status
      </metal:block>
      <metal:block fill-slot="content">
        <select name="status"
          tal:define="myid python:here.getCalendar().id;
              mystatus python:[att for att in here.attendees if att['id'] == myid][0]['status']">
          <option tal:repeat="status python:['confirmed', 'tentative', 'decline']"
              tal:attributes="value status;
                      selected python:status == mystatus"
              tal:content="python:str('cpscalendar_pending_%s' % (status,))"
              i18n:translate="">
         Status
           </option>
        </select>
      </metal:block>
    </metal:block>
    <metal:block use-macro="here/calendar_macros/macros/form_property">
      <metal:block fill-slot="title"
                   i18n:translate="cpscalendar_label_comment">
        Comment
      </metal:block>
      <metal:block fill-slot="content">
        <textarea name="comment" cols="40" rows="4"></textarea>
      </metal:block>
    </metal:block>
      </metal:block>
    </metal:block>
    <input type="submit"
           value="cpscalendar_button_modify"
           i18n:attributes="value" />
    <input type="button" onClick="history.back()"
           value="cpscalendar_button_cancel"
           i18n:attributes="value" />
  </form>
</metal:block>

</html>
</tal:block>
