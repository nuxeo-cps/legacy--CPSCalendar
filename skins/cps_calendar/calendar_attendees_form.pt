<tal:block define="global current_action string:attendees" />
<html metal:use-macro="here/main_template/macros/master">

<metal:block fill-slot="main" i18n:domain="cpscalendar"
             tal:define="this_user here/getCalendarUser;
                         user_types here/getUserTypes;
                         attendees_dict here/getAttendeesDict|python:{};
                         caltool here/portal_cpscalendar;
                         dtool here/portal_directories/members;
                         decline_attendees python:[att for att in here.attendees if att['status'] == 'decline'];
                         all_attendees caltool/getCalendarsDict|python:{};
                         can_edit python:here.canEditThisEvent();">

  <h1>
    <span tal:replace="here/title_or_id">Title</span>:
    <span i18n:translate="cpscalendar_attendees_management">Attendees
      management</span>
  </h1>

  <tal:block condition="python:decline_attendees and can_edit">
    <form action="calendar_removeattendee" method="POST">
      <input type="hidden" name="ids:list"
        tal:repeat="att decline_attendees"
        tal:attributes="value att/id" />
      <input type="submit"
             value="button_cpscalendar_remove_all_attendees_who_declined"
             i18n:attributes="value" />
    </form>
  </tal:block>

  <metal:block use-macro="here/calendar_macros/macros/notifyattendees" />

  <tal:block repeat="user_type user_types">
    <h2 class="label" tal:content="python:str(user_type['plural_title'])"
        i18n:translate="">cpscalendar_ressources</h2>
    <tal:block define="type user_type/id;
                       attendees attendees_dict/?type|python:[]">
      <p tal:condition="not:attendees"
         tal:content="python:str('cpscalendar_no_attendee_of_type_%s' % type)"
         i18n:translate="">
        cpscalendar_no_ressources_selected
      </p>
      <tal:block condition="python:can_edit and attendees">
        <form action="calendar_removeattendee" method="POST">
          <ul>
            <li tal:repeat="attendee attendees">
              <input type="checkbox" name="ids:list"
                tal:attributes="value string:${attendee/id}" />
              <tal:block replace="attendee/cn|attendee/id" />
              (<tal:block content="python:str('cpscalendar_status_%s' % (attendee['status'], ))"
                          i18n:translate="">cpscalendar_confirmed</tal:block>)
            </li>
          </ul>
          <input type="submit"
                 value="cpscalendar_button_delete"
                 i18n:attributes="value" />
        </form>
      </tal:block>
      <tal:block condition="python:(not can_edit) and attendees">
        <ul>
          <li tal:repeat="attendee attendees">
            <tal:block replace="attendee/cn|attendee/id" />
            (<tal:block content="python:str('cpscalendar_status_%s' % (attendee['status'], ))"
                        i18n:translate="">cpscalendar_confirmed</tal:block>)
          </li>
        </ul>
      </tal:block>
      <tal:block condition="can_edit">
        <tal:block condition="python:type =='member'">
          <tal:block define="
            searching python:request.get('role_submit', None);
            widgets here/portal_cpscalendar/getSearchWidgets;">
            <tal:block condition="python: not searching">
              <form method="POST" action="calendar_attendees_form">
                <p>
                  <span i18n:translate="cpscalendar_label_add_a_user_whose">
                    Add a user whose
                  </span>
                  <select name="search_param">
                    <tal:span repeat="widget widgets">
                      <option tal:condition="python:'search' not in widget.hidden_layout_modes"
                              tal:attributes="value python:widget.getWidgetId()">
                        <span  tal:condition="widget/is_i18n"
                               i18n:domain="Default" i18n:translate=""
                               tal:content="widget/label">label</span
                        ><span tal:condition="not:widget/is_i18n"
                               tal:content="widget/label">label</span
                      ></option>
                    </tal:span>
                  </select>
                  <span i18n:translate="cpscalendar_label_add_a_user_whose_is">
                    is
                  </span> :
                  <input type="text" name="search_term" size="10">
                  <input class="mainbutton" type="submit" name="role_submit"
                         value="cpscalendar_button_search"
                         i18n:attributes="value">
                </p>
              </form>
            </tal:block>
            <tal:block condition="searching">
              <tal:block define="search_param python: request.get('search_param', '');
                                 search_term  python: request.get('search_term', '');
                                 found python:search_param and dtool.searchEntries(**{search_param: search_term});
                                 found python:[member for member in found if member != this_user]">
                <tal:block condition="found">
                  <form method="POST" action="calendar_addattendee">
                    <p>
                      <span i18n:translate="cpscalendar_label_add_attendee">
                        Add
                      </span>
                      <br>
                      <select name="ids:list" size="5" multiple>
                        <tal:block repeat="user_id found">
                          <tal:block define="props python:dtool.getEntry(user_id)">
                            <option
                              tal:define="path python:caltool.getCalendarPathForUser(user_id)"
                              tal:condition="path"
                              tal:attributes="value path"
                              tal:content="python:props['fullname']">
                              Username
                            </option>
                         </tal:block>
                        </tal:block>
                      </select>
                      <br>
                      <input class="mainbutton" type="submit"
                             value="cpscalendar_button_add"
                             i18n:attributes="value">
                    </p>
                  </form>
                </tal:block>
                <p tal:condition="python: not found"
                   i18n:translate="cpscalendar_message_no_user_matching">
                    Sorry, there isn't any user matching your query
                </p>
              </tal:block>
            </tal:block>
          </tal:block>
        </tal:block>

        <tal:block condition="python:type != 'member'">
          <tal:block define="addable_attendees all_attendees/?type|python:[];
                             attendees_ids python:[att['rpath'] for att in attendees];
                             addable_attendees python:[att for att in addable_attendees if (att['rpath'] not in attendees_ids) and att['rpath'] != this_user]">
            <form action="calendar_addattendee"
              tal:condition="addable_attendees">
              <span i18n:translate="cpscalendar_label_add_attendee">
                Add
              </span>
              <select name="id">
                <option tal:repeat="attendee addable_attendees"
                  tal:attributes="value attendee/rpath"
                  tal:content="attendee/cn">Ressource</option>
              </select>
              <input type="submit"
                     value="cpscalendar_button_add"
                     i18n:attributes="value" />
            </form>
          </tal:block>
        </tal:block>
      </tal:block>
    </tal:block>
  </tal:block>
</metal:block>

</html>
