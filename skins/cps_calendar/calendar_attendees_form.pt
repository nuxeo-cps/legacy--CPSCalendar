<tal:block define="global current_action string:attendees" />
<html metal:use-macro="here/main_template/macros/master"
      i18n:domain="cpscalendar">

<metal:block fill-slot="head_slot">
  <span i18n:translate="cpscalendar_heading_event_attendees">
    Attendees for event
  </span>
  «&nbsp;<span tal:replace="here/title_or_id">Title</span>&nbsp;»
</metal:block>

<metal:block fill-slot="main"
             tal:define="this_user here/getCalendarUser;
                         user_types here/getUserTypes;
                         attendees_dict here/getAttendeesDict;
                         dtool here/portal_metadirectories/members;
                         decline_attendees python:[att for att in here.attendees if att['status'] == 'decline'];
                         all_attendees here/getCalendarsDict;
                         can_edit python:here.canEditThisEvent();">
  <tal:block condition="python:decline_attendees and can_edit">
    <form action="calendar_removeattendee" method="POST">
      <input type="hidden" name="ids:list"
        tal:repeat="att decline_attendees"
        tal:attributes="value att/id" />
      <input type="submit"
             value="button_remove_all_attendees_who_declined"
             i18n:attributes="value" />
    </form>
  </tal:block>
  <metal:block use-macro="here/calendar_macros/macros/notifyattendees" />
  <tal:block repeat="user_type user_types">
    <span class="calTitle" tal:content="python:str(user_type['plural_title'])"
        i18n:translate="">Ressources</span>
    <tal:block define="type user_type/id;
                       attendees attendees_dict/?type|python:[]">
      <p tal:condition="not:attendees"
         tal:content="python:str('_cal_no_attendee_of_type_%s_' % type)"
         i18n:translate="">
        No ressources selected
      </p>
      <tal:block condition="python:can_edit and attendees">
        <form action="calendar_removeattendee" method="POST">
          <ul>
            <li tal:repeat="attendee attendees">
              <input type="checkbox" name="ids:list"
                tal:attributes="value string:${attendee/id}" />
              <tal:block replace="attendee/cn|attendee/id" />
              (<tal:block content="python:str('_cal_status_%s_' % (attendee['status'], ))"
                          i18n:translate="">Confirmed</tal:block>)
            </li>
          </ul>
          <input type="submit"
                 value="button_delete"
                 i18n:attributes="value" />
        </form>
      </tal:block>
      <tal:block condition="python:(not can_edit) and attendees">
        <ul>
          <li tal:repeat="attendee attendees">
            <tal:block replace="attendee/cn|attendee/id" />
            (<tal:block content="python:str('_cal_status_%s_' % (attendee['status'], ))"
                        i18n:translate="">Confirmed</tal:block>)
          </li>
        </ul>
      </tal:block>
      <tal:block condition="can_edit">
        <tal:block condition="python:type =='member'">

          <tal:block define="searching python: request.get('role_submit', None);
                             searchable_keys dtool/getSearchableSchemaKeys;
                             schema_dict dtool/getSchemaDict;
                             searchable_keys python:[key for key in searchable_keys if schema_dict[key].type == 'string'];">
            <tal:block condition="python: not searching">
              <form method="post" action="calendar_attendees_form">
                <p>
                  <span i18n:translate="cpscalendar_label_add_a_user_whose">
                    Add a user whose
                  </span>
                  <select name="search_param">
                   <option tal:repeat="propid searchable_keys"
                           tal:attributes="value propid"
                           tal:content="python:str(schema_dict[propid].title)"
                           i18n:translate="">option1</option>
                  </select>
                  <span i18n:translate="cpscalendar_label_(add_a_user_whose_)is">
                    is
                  </span>:
                  <input type="text" name="search_term" size="10">
                  <input class="mainbutton" type="submit" name="role_submit"
                         value="button_search"
                         i18n:attributes="value">
                </p>
              </form>
            </tal:block>
            <tal:block condition="searching">
              <tal:block define="search_param python: request.get('search_param', '');
                                 search_term  python: request.get('search_term', '');
                                 found python:search_param and dtool.searchEntry(**{search_param: search_term});
                                 found python:[member for member in found if member[dtool.entry_prop] != this_user]">
                <tal:block condition="found">
                  <form method="post" action="calendar_addattendee">
                    <p>
                      <span i18n:translate="cpscalendar_label_add_attendee">
                        Add
                      </span>
                      <br>
                      <select name="ids:list" size="5" multiple>
                        <option value="."
                          tal:repeat="props found"
                          tal:attributes="value python:props[dtool.entry_prop]"
                          tal:content="python:props[dtool.display_prop]">
                          Username
                        </option>
                      </select>
                      <br>
                      <input class="mainbutton" type="submit"
                             value="button_add"
                             i18n:attributes="value">
                    </p>
                  </form>
                </tal:block>
                <p tal:condition="python: not found"
                   i18n:translate="cpscalendar_message_no_user_matching">
                    Sorry, there isn't any user matching your query
                </p>
              </tal:block>
            </tal:block>
          </tal:block>
        </tal:block>
        <tal:block condition="python:type != 'member'">
          <tal:block define="addable_attendees all_attendees/?type|python:[];
                             attendees_ids python:[att['id'] for att in attendees];
                             addable_attendees python:[att for att in addable_attendees if (att['id'] not in attendees_ids) and att['id'] != this_user]">
            <form action="calendar_addattendee"
              tal:condition="addable_attendees">
              <span i18n:translate="cpscalendar_label_add_attendee">
                Add
              </span>
              <select name="id">
                <option tal:repeat="attendee addable_attendees"
                  tal:attributes="value attendee/id"
                  tal:content="attendee/cn">Ressource</option>
              </select>
              <input type="submit"
                     value="button_add"
                     i18n:attributes="value" />
            </form>
          </tal:block>
        </tal:block>
      </tal:block>
    </tal:block>
  </tal:block>
</metal:block>

</html>
