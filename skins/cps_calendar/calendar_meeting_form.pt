<tal:block define="global current_action string:meeting" />
<html metal:use-macro="here/main_template/macros/master">

<metal:block fill-slot="css_slot">
  <style type="text/css"
    tal:content="string:@import url(${base_url}calendar-win2k-1.css);"></style>
  <script type="text/javascript" src="calendar.js"
    tal:attributes="src string:${base_url}calendar.js"></script>

  <script type="text/javascript" src="lang/calendar-en.js"
    tal:define="locale cpsmcat/get_selected_language|string:en"
    tal:attributes="src string:${base_url}lang/calendar-${locale}.js"></script>
  <script type="text/javascript" src="calendar-setup.js"
    tal:attributes="src string:${base_url}calendar-setup.js"></script>
</metal:block>

<metal:block fill-slot="main" i18n:domain="cpscalendar"
             tal:define="portal_url python:here.portal_url(relative=1);
                         edit request/form/edit|nothing;
                         caltool here/portal_cpscalendar;
                         dtool here/portal_directories/members;
                         title_field dtool/title_field;
                         disp_infos python:here.calendar_getDispInformations(request);
                         selected_day disp_infos/selected_day;
                         args python:edit and request.SESSION['meeting']['args'];
                         from_date_year python:edit and int(args['from_date_year']) or selected_day.year();
                         from_date_month python:edit and int(args['from_date_month']) or selected_day.month();
                         from_date_day python:edit and int(args['from_date_day']) or selected_day.day();
                         to_date_year python:edit and int(args['to_date_year']) or selected_day.year();
                         to_date_month python:edit and int(args['to_date_month']) or selected_day.month();
                         to_date_day python:edit and int(args['to_date_day']) or selected_day.day();
                         from_date python:DateTime(from_date_year, from_date_month, from_date_day);
                         to_date python:DateTime(to_date_year, to_date_month, to_date_day);
                         from_date_hour python:(edit and [int(args['from_date_hour'])] or [8])[0];
                         from_date_minute python:(edit and [int(args['from_date_minute'])] or [0])[0];
                         to_date_hour python:(edit and [int(args['to_date_hour'])] or [19])[0];
                         to_date_minute python:(edit and [int(args['to_date_minute'])] or [0])[0];
                         my_cal here/portal_cpscalendar/getHomeCalendarObject;
                         my_id my_cal/getRpath;
                         cal_ids request/cal_ids|request/SESSION/meeting/cal_ids|python:[my_id];
                         new_cal_ids here/REQUEST/ids|python:[];
                         cal_ids python:cal_ids + [id for id in new_cal_ids if not id in cal_ids];
                         del_cal_ids here/REQUEST/del_cal_ids|python:[];
                         cal_ids python:[c for c in cal_ids if not c in del_cal_ids];
                         session request/SESSION;
                         sm python: session.get('meeting') or {};
                         foo python:session.update({'meeting': sm});
                         foo python:sm.update({'cal_ids': cal_ids});
                         current_list cal_ids;
                         user_types here/getUserTypes;
                         all_calendars here/portal_cpscalendar/getCalendarsDict;
                         addaction string:calendar_meeting_form;
                         searchaction string:calendar_meeting_form; 
                         ">

  <h1 i18n:domain="cpscalendar"
      i18n:translate="cpscalendar_heading_meeting_creation_helper">
    Meeting creation helper
  </h1>
  <metal:block use-macro="here/calendar_macros/macros/searchform">
    the searchform
  </metal:block>
  <hr/>
  <form method="POST" tal:attributes="action here/REQUEST/URL1">
    <p>
      <strong>
      <span i18n:translate="cpscalendar_label_from_day">
        From
      </span>
  <input type="text" size="11" maxlength="22"
    tal:attributes="name string:from_date;
                    id string:from_date;
                    value python:here.getDateStr(from_date, fmt='short')" />
  <button id="trigger"
    tal:attributes="id string:trigger_from_date">...</button>
  <tal:block define="fmt python:here.Localizer.default('jscalendar_date_fmt');"
    replace="structure string:<script type='text/javascript'>
Calendar.setup(
{
inputField  : 'from_date',
ifFormat    : '${fmt}',
button      : 'trigger_from_date',
mondayFirst : true,
range       : [2000, 2049]
}
);
  </script>" />
      <span i18n:translate="cpscalendar_label_to_day">
        to
      </span>
  <input type="text" size="11" maxlength="22"
    tal:attributes="name string:to_date;
                    id string:to_date;
                    value python:here.getDateStr(to_date, fmt='short')" />
  <button id="trigger"
    tal:attributes="id string:trigger_to_date">...</button>
  <tal:block define="fmt python:here.Localizer.default('jscalendar_date_fmt');"
    replace="structure string:<script type='text/javascript'>
Calendar.setup(
{
inputField  : 'to_date',
ifFormat    : '${fmt}',
button      : 'trigger_to_date',
mondayFirst : true,
range       : [2000, 2049]
}
);
</script>" />
      </strong>
    </p>
    <p>
      <strong>
      <span i18n:translate="cpscalendar_label_between">
        Between
      </span>
      <select name="from_date_hour:int">
        <option tal:repeat="hour python:range(0,24)"
                tal:content="hour"
                tal:attributes="value hour;
                                selected python:hour == from_date_hour;" />
      </select>
      <span i18n:translate="cpscalendar_hour_sep">:</span>
      <select name="from_date_minute:int">
        <option tal:repeat="minute python:range(0,60,5)"
                tal:content="python:'%02d' % minute"
                tal:attributes="value minute;
                                selected python:minute == from_date_minute;" />
      </select>
      <span i18n:translate="cpscalendar_label_and">and</span>
      <select name="to_date_hour:int">
        <option tal:repeat="hour python:range(0,24)"
                tal:content="hour"
                tal:attributes="value hour;
                                selected python:hour == to_date_hour;" />
      </select>
      <span i18n:translate="cpscalendar_hour_sep">:</span>
      <select name="to_date_minute:int">
        <option tal:repeat="minute python:range(0,60,5)"
                tal:content="python:'%02d' % minute"
                tal:attributes="value minute;
                                selected python:minute == to_date_minute;" />
      </select>
      </strong>
    </p>
    <p tal:condition="nothing">
    <span class="calTitle" i18n:translate="cpscalendar_message_select_the_desired_duration_of_your_meeting">
      Select the desired duration for your meeting
    </span> :
    </p>
    <p tal:condition="nothing">
      <select name="duration_hour:int">
        <option tal:repeat="hour python:range(0,24)"
          tal:content="hour" tal:attributes="value hour;
            selected python:hour == 1 or nothing" />
      </select>
      <span i18n:translate="cpscalendar_hour_sep">:</span>
      <select name="duration_minute:int">
        <option tal:repeat="minute python:range(0,60,15)"
          tal:content="python:'%02d' % minute"
          tal:attributes="value minute;
            selected python:minute == 0 or nothing" />
      </select>
    </p>
    <input type="submit"
           value="cpscalendar_button_search"
           i18n:attributes="value" 
           tal:attributes="name string:calendar_begin_meeting:method" />
    <input type="button" onClick="history.back()"
           value="cpscalendar_button_cancel"
           i18n:attributes="value" />
    <hr/>
    <p class="calTitle">
      <span i18n:translate="cpscalendar_message_select_the_attendees_you_want_for_your_meeting">
        Select the attendees you want for your meeting
      </span>:
    </p>
    <p tal:repeat="cal cal_ids">
        <input type="checkbox" name="cal_ids:list" checked
          tal:attributes="value cal" />
        <span tal:define="calob python:caltool.getCalendarForPath(cal, unrestricted=1);
          userid calob/getCalendarUser;
          user python:dtool.getEntry(userid);
          "
          tal:replace="user/?title_field">
          calendarid
        </span>
    </p>
    <input type="submit" name="calendar_meeting_form:method"
      i18n:attributes="value" value="cpscalendar_button_validate"/>
  </form>
</metal:block>
</html>
